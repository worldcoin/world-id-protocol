name: Mobile Bench PR Helper

on:
  pull_request_target:
    types:
      - opened
      - reopened
      - synchronize

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  post-helper-comment:
    name: Post benchmark helper comment
    runs-on: ubuntu-latest
    steps:
      - name: Upsert helper comment
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.pull_request.number;
            const marker = "<!-- mobench-pr-helper -->";
            const workflowUrl = `https://github.com/${owner}/${repo}/actions/workflows/mobile-bench-ios.yml`;

            const body = `${marker}
            ## Mobile Bench Runner

            Use this PR comment command to dispatch BrowserStack benchmarks against this PR branch:

            \`\`\`text
            /mobench platforms=both iterations=30 warmup=5 proof_scope=both modes=all device_profile=auto-low-spec
            \`\`\`

            Quick examples:

            \`\`\`text
            /mobench platforms=ios proof_scope=pi2 modes=proving iterations=20 warmup=3 device_profile=low-spec
            /mobench platforms=android proof_scope=both modes=witness,proving iterations=15 warmup=2 device_profile=mid-spec
            /mobench platforms=both device_profile=custom ios_device="iPhone 11" ios_os_version="14" android_device="Google Pixel 6" android_os_version="12"
            \`\`\`

            Supported keys:
            - \`platforms\`: \`both\` | \`ios\` | \`android\`
            - \`iterations\`: positive integer
            - \`warmup\`: non-negative integer
            - \`fetch_timeout_secs\`: positive integer
            - \`proof_scope\`: \`both\` | \`pi2\` | \`pi1\`
            - \`modes\`: \`all\` or comma list of \`witness,proving,full\`
            - \`device_profile\`: \`low-spec\` | \`mid-spec\` | \`high-spec\` | \`auto-low-spec\` | \`custom\`
            - \`ios_device\`, \`ios_os_version\`, \`android_device\`, \`android_os_version\`: required only for \`device_profile=custom\`
            - \`mobench_ref\`: optional ref for worldcoin/mobile-bench-rs (default: \`codex/ci-devex\`)

            Manual dispatch UI: ${workflowUrl}
            `;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
              per_page: 100,
            });

            const existing = comments.find((c) => c.body && c.body.includes(marker));
            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
              core.info(`Updated helper comment ${existing.id}`);
            } else {
              const created = await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
              core.info(`Created helper comment ${created.data.id}`);
            }
