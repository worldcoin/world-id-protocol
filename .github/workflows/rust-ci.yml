name: Rust CI

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: read

concurrency:
  group: >
    ${{ github.event_name == 'pull_request'
        && format('pr-{0}', github.event.pull_request.number)
        || format('main-{0}', github.run_id) }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  CARGO_TERM_COLOR: always

jobs:
  lint:
    name: Format and Clippy
    runs-on:
      group: arc-public-4xlarge-amd64-runner
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
          components: clippy,rustfmt

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Build contracts
        run: |
          make sol-build

      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt

      - name: Check code formatting
        run: cargo +nightly fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  msrv:
    name: MSRV
    runs-on:
      group: arc-public-large-amd64-runner
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.87

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Build contracts
        run: |
          make sol-build

      - name: Check Features
        run: |
          cargo check --all-features

  feature:
    name: Feature Resolution (cargo-hack)
    runs-on:
      group: arc-public-large-amd64-runner
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Build contracts
        run: |
          make sol-build

      - name: Install cargo-hack
        run: |
          cargo install cargo-hack --locked

      - name: Check Features
        run: |
          cargo hack check --each-feature --no-dev-deps

  test:
    name: Tests
    runs-on:
      group: arc-public-8xlarge-amd64-runner
    permissions:
      contents: read

    # Log in to Docker Hub if a token is provided to avoid public rate limiting
    env:
      IS_DOCKER_TOKEN_SET: ${{ (secrets.DOCKER_HUB_PULL_PUBLIC_IMAGES_TOKEN != '' && secrets.DOCKER_HUB_PULL_PUBLIC_IMAGES_USERNAME != '') && 'true' || 'false' }}

    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0 https://github.com/docker/login-action/releases/tag/v3.6.0
        if: ${{ env.IS_DOCKER_TOKEN_SET == 'true' }}
        with:
          username: ${{ secrets.DOCKER_HUB_PULL_PUBLIC_IMAGES_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PULL_PUBLIC_IMAGES_TOKEN }}

      - name: Checkout code
        uses: actions/checkout@v5

      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Build contracts
        run: |
          make sol-build

      - name: Run services
        run: |
          docker compose up -d
          sleep 5

      - name: Run tests
        env:
          TESTS_RPC_FORK_URL: ${{ secrets.TESTS_RPC_FORK_URL }}
        run: |
          cargo test --all --all-features
          cargo test -p world-id-core --no-default-features

      - name: Clean up services
        run: |
          docker compose down

  deny:
    name: Cargo deny
    runs-on:
      group: arc-public-large-amd64-runner
    permissions:
      contents: read
    strategy:
      matrix:
        checks:
          - advisories
          - bans licenses sources

    continue-on-error: ${{ matrix.checks == 'advisories' }}

    # Log in to Docker Hub if a token is provided to avoid public rate limiting
    env:
      IS_DOCKER_TOKEN_SET: ${{ (secrets.DOCKER_HUB_PULL_PUBLIC_IMAGES_TOKEN != '' && secrets.DOCKER_HUB_PULL_PUBLIC_IMAGES_USERNAME != '') && 'true' || 'false' }}

    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0 https://github.com/docker/login-action/releases/tag/v3.6.0
        if: ${{ env.IS_DOCKER_TOKEN_SET == 'true' }}
        with:
          username: ${{ secrets.DOCKER_HUB_PULL_PUBLIC_IMAGES_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PULL_PUBLIC_IMAGES_TOKEN }}

      - name: Checkout code
        uses: actions/checkout@v4

      - uses: EmbarkStudios/cargo-deny-action@v2.0.14
        with:
          command: check ${{ matrix.checks }}

  docker:
    name: Test Docker build
    runs-on:
      group: arc-public-8xlarge-amd64-runner
    strategy:
      matrix:
        service:
          - indexer
          - gateway
    permissions:
      contents: read

    # Log in to Docker Hub if a token is provided to avoid public rate limiting
    env:
      IS_DOCKER_TOKEN_SET: ${{ (secrets.DOCKER_HUB_PULL_PUBLIC_IMAGES_TOKEN != '' && secrets.DOCKER_HUB_PULL_PUBLIC_IMAGES_USERNAME != '') && 'true' || 'false' }}

    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0 https://github.com/docker/login-action/releases/tag/v3.6.0
        if: ${{ env.IS_DOCKER_TOKEN_SET == 'true' }}
        with:
          username: ${{ secrets.DOCKER_HUB_PULL_PUBLIC_IMAGES_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PULL_PUBLIC_IMAGES_TOKEN }}

      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build
        uses: docker/build-push-action@v6
        id: docker_build
        with:
          push: false
          load: true
          tags: ${{ matrix.service }}:latest
          cache-from: type=gha
          cache-to: "type=gha,mode=max"
          platforms: linux/amd64
          build-args: SERVICE_NAME=world-id-${{ matrix.service }}

      - name: Run services
        run: |
          docker compose up -d
          sleep 5

      - name: Run Docker container
        run: |
          # We run the http-only mode to avoid having to set up the RPC provider
          docker run -d --network host --env-file services/${{ matrix.service }}/.env.example --env LISTEN_ADDR=0.0.0.0:8080 --env RUN_MODE=http-only --name ${{ matrix.service }}-container ${{ matrix.service }}:latest

          # Wait for the application to start
          sleep 10

          # Output logs to GitHub action
          docker logs ${{ matrix.service }}-container

      - name: Health check Docker container
        run: curl -f http://0.0.0.0:8080/health

      - name: Clean up
        run: |
          docker stop ${{ matrix.service }}-container
          docker rm ${{ matrix.service }}-container
          docker compose down

  wasm:
    name: WASM Compatibility
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Check primitives compiles for WASM
        run: |
          # Test WASM compilation without the 'circuits' feature (which has C++ deps)
          # This ensures primitives can be used in WASM environments like browsers
          cargo check -p world-id-primitives --target wasm32-unknown-unknown --no-default-features

  docs:
    name: Check docs
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      RUSTDOCFLAGS: -Dwarnings
    steps:
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@nightly
      - uses: dtolnay/install@cargo-docs-rs
      - run: |
          cargo +nightly docs-rs -p world-id-primitives
          cargo +nightly docs-rs -p world-id-core
